Index

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MachineLog</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; margin: 0; padding: 0; }
        body { background: #f5f5f5; }
       
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
       
        .header { background: #007bff; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 20px; }
        .back-btn { position: absolute; left: 15px; top: 15px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
       
        .container { padding: 15px; max-width: 800px; margin: 0 auto; padding-bottom: 100px; }
       
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        textarea { min-height: 80px; resize: vertical; }
       
        button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; width: 100%; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-camera { background: #17a2b8; color: white; width: 100%; margin-top: 5px; }
       
        .card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .machine-card { border-left: 4px solid #007bff; cursor: pointer; transition: transform 0.2s; }
        .machine-card:hover { transform: translateX(5px); }
        .machine-card h3 { color: #007bff; margin-bottom: 5px; }
       
        .machine-header { background: white; padding: 20px; margin: -15px -15px 20px -15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .machine-header h2 { color: #007bff; margin-bottom: 10px; }
        .machine-info { color: #666; font-size: 14px; }
       
        .tabs { display: flex; background: white; margin: 0 -15px 20px -15px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #007bff; color: #007bff; font-weight: bold; }
       
        .tab-content { display: none; }
        .tab-content.active { display: block; }
       
        .log-entry { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #28a745; }
        .log-entry.pending { border-left-color: #ffc107; }
        .log-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .log-date { color: #666; font-size: 12px; }
        .log-tech { color: #007bff; font-weight: bold; }
        .log-section { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .log-label { font-weight: bold; color: #333; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .alarm-text { color: #dc3545; }
        .solution-text { color: #28a745; }
        .parts-text { color: #fd7e14; }
       
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .photo-grid img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; }
       
        .upload-box { border: 3px dashed #007bff; padding: 40px; text-align: center; border-radius: 10px; margin: 15px 0; background: #f0f8ff; cursor: pointer; }
        .upload-box:active { background: #e3f2fd; }
       
        .manual-item { background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .manual-item a { background: #007bff; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-size: 14px; }
       
        .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
       
        .empty-state { text-align: center; padding: 40px; color: #999; }
       
        .login-box { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .login-box h2 { text-align: center; margin-bottom: 20px; color: #007bff; }
       
        /* Camera styles */
        .camera-container { position: relative; width: 100%; margin: 10px 0; }
        #cameraVideo { width: 100%; max-height: 300px; background: #000; display: none; }
        #cameraCanvas { display: none; }
        .camera-btn { width: 100%; margin: 5px 0; }
        .preview-img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; position: relative; }
        .photo-wrapper { position: relative; display: inline-block; width: 32%; margin: 1% 0.5%; }
        .remove-btn { position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; line-height: 1; }
       
        .debug-info { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; color: #856404; display: none; }
    </style>
</head>
<body>

<!-- ==================== LOGIN ==================== -->
<div id="loginScreen" class="screen active">
    <div class="login-box">
        <h2>üîß MachineLog</h2>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" value="admin@test.com">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPass" value="admin123">
        </div>
        <button class="btn-primary" onclick="login()">Login</button>
        <button class="btn-secondary" onclick="showScreen('registerScreen')" style="margin-top:10px; width:100%;">Create Account</button>
        <div id="loginError" style="color:red; margin-top:10px;"></div>
    </div>
</div>

<!-- ==================== REGISTER ==================== -->
<div id="registerScreen" class="screen">
    <div class="login-box">
        <h2>Create Account</h2>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="regName">
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="regEmail">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="regPass">
        </div>
        <div class="form-group">
            <label>Role</label>
            <select id="regRole">
                <option value="technician">Technician</option>
                <option value="admin">Admin</option>
            </select>
        </div>
        <button class="btn-primary" onclick="register()">Register</button>
        <button class="btn-secondary" onclick="showScreen('loginScreen')" style="margin-top:10px; width:100%;">Back</button>
        <div id="regError" style="color:red; margin-top:10px;"></div>
    </div>
</div>

<!-- ==================== MACHINES LIST ==================== -->
<div id="machinesListScreen" class="screen">
    <div class="header">
        <h1>Machines</h1>
        <button class="back-btn" onclick="logout()">Logout</button>
    </div>
    <div class="container">
        <div id="adminAddMachine" style="display:none;">
            <div class="card">
                <h3>Add New Machine</h3>
                <div class="form-group">
                    <label>Machine Name *</label>
                    <input type="text" id="newMachineName" placeholder="e.g., CNC Lathe 01">
                </div>
                <div class="form-group">
                    <label>Model/Type</label>
                    <input type="text" id="newMachineModel" placeholder="e.g., HAAS ST-20">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="newMachineLocation" placeholder="e.g., Building A, Line 2">
                </div>
                <button class="btn-success" onclick="addMachine()">Create Machine</button>
            </div>
        </div>
       
        <h3 style="margin-top:20px;">Select Machine</h3>
        <div id="machinesContainer"></div>
    </div>
</div>

<!-- ==================== MACHINE DETAIL ==================== -->
<div id="machineDetailScreen" class="screen">
    <div class="header">
        <button class="back-btn" onclick="backToMachines()">‚Üê Back</button>
        <h1 id="machineDetailTitle">Machine</h1>
    </div>
   
    <div class="machine-header">
        <h2 id="machineNameDisplay">Machine Name</h2>
        <div class="machine-info">
            <span id="machineModelDisplay">Model</span> |
            <span id="machineLocationDisplay">Location</span>
        </div>
    </div>
   
    <div class="tabs">
        <div class="tab active" onclick="switchTab('logs')">üìã Logs</div>
        <div class="tab" onclick="switchTab('manuals')">üìÑ Manuals</div>
        <div class="tab" onclick="switchTab('add')">‚ûï Add Log</div>
    </div>
   
    <div class="container">
       
        <!-- LOGS TAB -->
        <div id="logsTab" class="tab-content active">
            <div id="logsContainer"></div>
        </div>
       
        <!-- MANUALS TAB -->
        <div id="manualsTab" class="tab-content">
            <div id="adminUploadSection" style="display:none;">
                <div class="upload-box" onclick="triggerManualUpload()">
                    <div style="font-size: 50px;">üìÑ</div>
                    <p style="margin-top:10px; font-weight:bold; color:#007bff;">Tap to Upload Manual</p>
                    <p style="color:#666; font-size:14px;">PDF, DOC, or Images</p>
                </div>
                <input type="file" id="manualFileInput" style="display:none;" accept=".pdf,.doc,.docx,image/*" onchange="handleManualUpload(this)">
                <div id="manualDebug" class="debug-info"></div>
            </div>
            <div id="manualsContainer"></div>
        </div>
       
        <!-- ADD LOG TAB -->
        <div id="addTab" class="tab-content">
            <div class="card">
                <h3>New Maintenance Log</h3>
               
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="logDate">
                </div>
               
                <div class="form-group">
                    <label>Technician Name *</label>
                    <input type="text" id="logTechName" placeholder="Who performed the work?">
                </div>
               
                <div class="form-group">
                    <label>Alarm / Fault Description *</label>
                    <textarea id="logAlarm" placeholder="What was the error code or fault?"></textarea>
                </div>
               
                <div class="form-group">
                    <label>Solution / Fix Applied *</label>
                    <textarea id="logSolution" placeholder="What was done to fix it?"></textarea>
                </div>
               
                <div class="form-group">
                    <label>Parts Replaced / Exchanged</label>
                    <input type="text" id="logParts" placeholder="Part numbers and quantities">
                </div>
               
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="logNotes" placeholder="Additional comments..."></textarea>
                </div>
               
                <!-- CAMERA SECTION -->
                <div class="form-group">
                    <label>Photos</label>
                   
                    <!-- Live Camera -->
                    <div class="camera-container">
                        <video id="cameraVideo" autoplay playsinline></video>
                        <canvas id="cameraCanvas"></canvas>
                    </div>
                   
                    <!-- Camera Controls -->
                    <div id="cameraControls" style="display:none;">
                        <button class="btn-success camera-btn" onclick="capturePhoto()">üì∏ Take Photo</button>
                        <button class="btn-secondary camera-btn" onclick="stopCamera()">‚ùå Cancel</button>
                    </div>
                   
                    <!-- Main Buttons -->
                    <div id="cameraMainButtons">
                        <button class="btn-camera" onclick="startCamera()">üì∑ Open Camera</button>
                        <button class="btn-secondary camera-btn" onclick="document.getElementById('galleryInput').click()">üñºÔ∏è Choose from Gallery</button>
                        <input type="file" id="galleryInput" accept="image/*" multiple style="display:none;" onchange="handleGallerySelect(this)">
                    </div>
                   
                    <div id="photoDebug" class="debug-info"></div>
                </div>
               
                <!-- PHOTO PREVIEWS -->
                <div id="photoPreviewContainer" style="margin-top:15px;"></div>
               
                <button class="btn-success" onclick="submitLog()" style="margin-top:20px;">üíæ Save Log</button>
                <div id="submitMessage" style="margin-top:10px; text-align:center; font-weight:bold;"></div>
            </div>
        </div>
       
    </div>
</div>

<script>
// ==========================================
// DATABASE
// ==========================================
const DB = {
    get(key) {
        try {
            const data = localStorage.getItem('ml_' + key);
            return data ? JSON.parse(data) : [];
        } catch(e) {
            console.error('DB get error:', e);
            return [];
        }
    },
    set(key, value) {
        try {
            localStorage.setItem('ml_' + key, JSON.stringify(value));
        } catch(e) {
            console.error('DB set error:', e);
            alert('Storage full! Delete some old data.');
        }
    },
    add(key, item) {
        const items = this.get(key);
        item.id = Date.now().toString();
        item.createdAt = new Date().toISOString();
        items.push(item);
        this.set(key, items);
        return item;
    },
    update(key, id, updates) {
        const items = this.get(key);
        const idx = items.findIndex(i => i.id === id);
        if (idx > -1) {
            items[idx] = { ...items[idx], ...updates };
            this.set(key, items);
            return items[idx];
        }
        return null;
    }
};

let currentUser = null;
let currentMachine = null;
let pendingPhotos = [];
let cameraStream = null;

// ==========================================
// AUTH
// ==========================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
   
    const users = DB.get('users');
    const user = users.find(u => u.email === email && u.password === pass);
   
    if (!user) {
        document.getElementById('loginError').textContent = 'Invalid credentials';
        return;
    }
   
    if (user.role === 'technician' && !user.approved) {
        document.getElementById('loginError').textContent = 'Account pending approval';
        return;
    }
   
    currentUser = user;
    document.getElementById('loginError').textContent = '';
    showMachinesList();
}

function register() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value;
    const role = document.getElementById('regRole').value;
   
    if (!name || !email || !pass) {
        document.getElementById('regError').textContent = 'Fill all fields';
        return;
    }
   
    const users = DB.get('users');
    if (users.find(u => u.email === email)) {
        document.getElementById('regError').textContent = 'Email exists';
        return;
    }
   
    DB.add('users', {
        name, email, password: pass, role,
        approved: role === 'admin'
    });
   
    alert('Registered! ' + (role === 'technician' ? 'Wait for approval.' : ''));
    showScreen('loginScreen');
}

function logout() {
    currentUser = null;
    currentMachine = null;
    pendingPhotos = [];
    stopCamera();
    showScreen('loginScreen');
}

// ==========================================
// MACHINES
// ==========================================
function showMachinesList() {
    showScreen('machinesListScreen');
    document.getElementById('adminAddMachine').style.display =
        currentUser.role === 'admin' ? 'block' : 'none';
    loadMachines();
}

function loadMachines() {
    const machines = DB.get('machines');
    const container = document.getElementById('machinesContainer');
   
    if (machines.length === 0) {
        container.innerHTML = '<div class="empty-state">No machines yet. Add one!</div>';
        return;
    }
   
    container.innerHTML = machines.map(m => `
        <div class="card machine-card" onclick="openMachine('${m.id}')">
            <h3>${m.name}</h3>
            <small>${m.model} | ${m.location}</small><br>
            <small style="color:#666;">${getLogCount(m.id)} logs | ${getManualCount(m.id)} manuals</small>
        </div>
    `).join('');
}

function getLogCount(machineId) {
    return DB.get('logs').filter(l => l.machineId === machineId).length;
}

function getManualCount(machineId) {
    return DB.get('manuals').filter(m => m.machineId === machineId).length;
}

function addMachine() {
    const name = document.getElementById('newMachineName').value.trim();
    const model = document.getElementById('newMachineModel').value.trim();
    const location = document.getElementById('newMachineLocation').value.trim();
   
    if (!name) {
        alert('Enter machine name');
        return;
    }
   
    DB.add('machines', { name, model: model || 'N/A', location: location || 'N/A' });
   
    document.getElementById('newMachineName').value = '';
    document.getElementById('newMachineModel').value = '';
    document.getElementById('newMachineLocation').value = '';
   
    loadMachines();
}

// ==========================================
// MACHINE DETAIL
// ==========================================
function openMachine(machineId) {
    const machines = DB.get('machines');
    currentMachine = machines.find(m => m.id === machineId);
   
    if (!currentMachine) return;
   
    document.getElementById('machineDetailTitle').textContent = currentMachine.name;
    document.getElementById('machineNameDisplay').textContent = currentMachine.name;
    document.getElementById('machineModelDisplay').textContent = currentMachine.model;
    document.getElementById('machineLocationDisplay').textContent = currentMachine.location;
   
    document.getElementById('adminUploadSection').style.display =
        currentUser.role === 'admin' ? 'block' : 'none';
   
    document.getElementById('logDate').valueAsDate = new Date();
   
    loadLogs();
    loadManuals();
    clearForm();
    switchTab('logs');
   
    showScreen('machineDetailScreen');
}

function backToMachines() {
    currentMachine = null;
    pendingPhotos = [];
    stopCamera();
    showMachinesList();
}

function clearForm() {
    document.getElementById('logTechName').value = '';
    document.getElementById('logAlarm').value = '';
    document.getElementById('logSolution').value = '';
    document.getElementById('logParts').value = '';
    document.getElementById('logNotes').value = '';
    document.getElementById('photoPreviewContainer').innerHTML = '';
    document.getElementById('submitMessage').textContent = '';
    pendingPhotos = [];
}

// ==========================================
// TABS
// ==========================================
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active',
            (tabName === 'logs' && i === 0) ||
            (tabName === 'manuals' && i === 1) ||
            (tabName === 'add' && i === 2)
        );
    });
   
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
   
    if (tabName === 'logs') loadLogs();
    if (tabName === 'manuals') loadManuals();
}

// ==========================================
// CAMERA - FIXED VERSION
// ==========================================
async function startCamera() {
    const debug = document.getElementById('photoDebug');
    debug.style.display = 'block';
    debug.textContent = 'Starting camera...';
   
    try {
        const video = document.getElementById('cameraVideo');
       
        // Stop any existing stream
        stopCamera();
       
        // Get camera
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        });
       
        video.srcObject = cameraStream;
        video.style.display = 'block';
        video.play();
       
        document.getElementById('cameraControls').style.display = 'block';
        document.getElementById('cameraMainButtons').style.display = 'none';
       
        debug.textContent = 'Camera active! Click Take Photo';
       
    } catch (err) {
        debug.textContent = 'Camera error: ' + err.message;
        console.error('Camera error:', err);
        alert('Cannot access camera: ' + err.message + '\n\nTry using "Choose from Gallery" instead.');
    }
}

function stopCamera() {
    const video = document.getElementById('cameraVideo');
   
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
   
    video.style.display = 'none';
    video.srcObject = null;
    document.getElementById('cameraControls').style.display = 'none';
    document.getElementById('cameraMainButtons').style.display = 'block';
    document.getElementById('photoDebug').style.display = 'none';
}

function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    const debug = document.getElementById('photoDebug');
   
    try {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
       
        const photoData = canvas.toDataURL('image/jpeg', 0.7);
       
        if (photoData.length < 100) {
            throw new Error('Empty photo data');
        }
       
        pendingPhotos.push(photoData);
        addPhotoToPreview(photoData, pendingPhotos.length - 1);
       
        debug.textContent = 'Photo captured! (' + pendingPhotos.length + ' total)';
        stopCamera();
       
    } catch (err) {
        debug.textContent = 'Capture error: ' + err.message;
        alert('Failed to capture: ' + err.message);
    }
}

function handleGallerySelect(input) {
    const debug = document.getElementById('photoDebug');
    debug.style.display = 'block';
   
    if (!input.files || input.files.length === 0) {
        debug.textContent = 'No files selected';
        return;
    }
   
    debug.textContent = 'Loading ' + input.files.length + ' photos...';
   
    Array.from(input.files).forEach((file, index) => {
        if (!file.type.startsWith('image/')) {
            debug.textContent += '\nSkipping non-image: ' + file.name;
            return;
        }
       
        const reader = new FileReader();
       
        reader.onload = function(e) {
            pendingPhotos.push(e.target.result);
            addPhotoToPreview(e.target.result, pendingPhotos.length - 1);
            debug.textContent = 'Loaded ' + pendingPhotos.length + ' photos';
        };
       
        reader.onerror = function() {
            debug.textContent = 'Error reading file: ' + file.name;
        };
       
        reader.readAsDataURL(file);
    });
   
    input.value = '';
}

function addPhotoToPreview(src, index) {
    const container = document.getElementById('photoPreviewContainer');
   
    const wrapper = document.createElement('div');
    wrapper.className = 'photo-wrapper';
    wrapper.innerHTML = `
        <img src="${src}" class="preview-img">
        <button class="remove-btn" onclick="removePhoto(${index})">√ó</button>
    `;
    container.appendChild(wrapper);
}

function removePhoto(index) {
    pendingPhotos.splice(index, 1);
    refreshPhotoPreviews();
}

function refreshPhotoPreviews() {
    const container = document.getElementById('photoPreviewContainer');
    container.innerHTML = '';
    pendingPhotos.forEach((src, idx) => addPhotoToPreview(src, idx));
}

// ==========================================
// MANUALS - FIXED VERSION
// ==========================================
function triggerManualUpload() {
    document.getElementById('manualFileInput').click();
}

function handleManualUpload(input) {
    const debug = document.getElementById('manualDebug');
    debug.style.display = 'block';
   
    if (!input.files || !input.files[0]) {
        debug.textContent = 'No file selected';
        return;
    }
   
    const file = input.files[0];
    debug.textContent = 'Reading: ' + file.name + ' (' + formatFileSize(file.size) + ')...';
   
    const reader = new FileReader();
   
    reader.onload = function(e) {
        try {
            const manual = {
                machineId: currentMachine.id,
                name: file.name,
                data: e.target.result,
                type: file.type,
                size: file.size,
                uploadedBy: currentUser.email,
                uploadedAt: new Date().toISOString()
            };
           
            DB.add('manuals', manual);
            debug.textContent = '‚úì Uploaded: ' + file.name;
            loadManuals();
           
        } catch (err) {
            debug.textContent = 'Save error: ' + err.message;
        }
    };
   
    reader.onerror = function() {
        debug.textContent = 'Read error! Try smaller file.';
    };
   
    reader.onprogress = function(e) {
        if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            debug.textContent = 'Reading... ' + pct + '%';
        }
    };
   
    // Read as data URL
    reader.readAsDataURL(file);
    input.value = '';
}

function loadManuals() {
    const manuals = DB.get('manuals').filter(m => m.machineId === currentMachine.id);
    const container = document.getElementById('manualsContainer');
   
    if (manuals.length === 0) {
        container.innerHTML = '<div class="empty-state">No manuals uploaded yet</div>';
        return;
    }
   
    container.innerHTML = manuals.map(m => {
        const isImage = m.type && m.type.startsWith('image');
        return `
        <div class="manual-item">
            <div style="flex:1;">
                <div style="font-weight:bold; word-break:break-all;">${m.name}</div>
                <small style="color:#666;">${formatFileSize(m.size)} ‚Ä¢ ${new Date(m.uploadedAt).toLocaleDateString()}</small>
                ${isImage ? `<br><img src="${m.data}" style="max-width:150px; margin-top:5px; border-radius:5px;">` : ''}
            </div>
            <a href="${m.data}" download="${m.name}" style="margin-left:10px; white-space:nowrap;">Download</a>
        </div>
    `}).join('');
}

function formatFileSize(bytes) {
    if (!bytes) return 'Unknown';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

// ==========================================
// LOGS
// ==========================================
function loadLogs() {
    const logs = DB.get('logs')
        .filter(l => l.machineId === currentMachine.id)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
   
    const container = document.getElementById('logsContainer');
   
    if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state">No maintenance logs yet</div>';
        return;
    }
   
    container.innerHTML = logs.map(log => `
        <div class="log-entry ${log.status === 'pending' ? 'pending' : ''}">
            <div class="log-header">
                <span class="log-tech">${log.technicianName}</span>
                <span class="log-date">${formatDate(log.date)}</span>
            </div>
           
            ${log.status === 'pending' ? '<span class="badge badge-pending">PENDING APPROVAL</span>' : ''}
           
            <div class="log-section">
                <div class="log-label">Alarm / Fault</div>
                <div class="alarm-text">${log.alarm}</div>
            </div>
           
            <div class="log-section">
                <div class="log-label">Solution</div>
                <div class="solution-text">${log.solution}</div>
            </div>
           
            ${log.parts ? `
            <div class="log-section">
                <div class="log-label">Parts Replaced</div>
                <div class="parts-text">${log.parts}</div>
            </div>` : ''}
           
            ${log.notes ? `
            <div class="log-section">
                <div class="log-label">Notes</div>
                <div>${log.notes}</div>
            </div>` : ''}
           
            ${log.photos && log.photos.length ? `
            <div class="photo-grid">
                ${log.photos.map(p => `<img src="${p}">`).join('')}
            </div>` : ''}
           
            ${currentUser.role === 'admin' && log.status === 'pending' ? `
            <div style="margin-top:10px;">
                <button class="btn-success" onclick="approveLog('${log.id}')" style="width:auto; margin-right:10px;">Approve</button>
                <button class="btn-danger" onclick="rejectLog('${log.id}')" style="width:auto;">Reject</button>
            </div>` : ''}
        </div>
    `).join('');
}

function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function submitLog() {
    const date = document.getElementById('logDate').value;
    const techName = document.getElementById('logTechName').value.trim();
    const alarm = document.getElementById('logAlarm').value.trim();
    const solution = document.getElementById('logSolution').value.trim();
    const parts = document.getElementById('logParts').value.trim();
    const notes = document.getElementById('logNotes').value.trim();
   
    if (!techName || !alarm || !solution) {
        alert('Fill required fields: Technician, Alarm, and Solution');
        return;
    }
   
    const msg = document.getElementById('submitMessage');
    msg.textContent = 'Saving...';
    msg.style.color = '#007bff';
   
    try {
        const log = {
            machineId: currentMachine.id,
            machineName: currentMachine.name,
            date: date || new Date().toISOString().split('T')[0],
            technicianName: techName,
            technicianEmail: currentUser.email,
            alarm: alarm,
            solution: solution,
            parts: parts,
            notes: notes,
            photos: [...pendingPhotos],
            status: currentUser.role === 'admin' ? 'approved' : 'pending',
            submittedBy: currentUser.email
        };
       
        DB.add('logs', log);
       
        clearForm();
       
        if (currentUser.role === 'admin') {
            msg.textContent = '‚úì Log saved!';
            msg.style.color = 'green';
        } else {
            msg.textContent = '‚è≥ Sent for approval';
            msg.style.color = 'orange';
        }
       
        setTimeout(() => {
            msg.textContent = '';
            switchTab('logs');
        }, 1500);
       
    } catch (err) {
        msg.textContent = 'Error: ' + err.message;
        msg.style.color = 'red';
    }
}

function approveLog(logId) {
    DB.update('logs', logId, {
        status: 'approved',
        approvedBy: currentUser.email,
        approvedAt: new Date().toISOString()
    });
    loadLogs();
}

function rejectLog(logId) {
    DB.update('logs', logId, {
        status: 'rejected',
        rejectedBy: currentUser.email,
        rejectedAt: new Date().toISOString()
    });
    loadLogs();
}

// ==========================================
// INIT
// ==========================================
function initDemo() {
    if (DB.get('users').length === 0) {
        DB.add('users', { name: 'Admin', email: 'admin@test.com', password: 'admin123', role: 'admin', approved: true });
        DB.add('users', { name: 'Tech John', email: 'tech@test.com', password: 'tech123', role: 'technician', approved: true });
       
        const m1 = DB.add('machines', { name: 'CNC Lathe 01', model: 'HAAS ST-20', location: 'Building A' });
       
        DB.add('logs', {
            machineId: m1.id,
            machineName: m1.name,
            date: '2024-01-15',
            technicianName: 'John Smith',
            technicianEmail: 'tech@test.com',
            alarm: 'Spindle overheating error #304',
            solution: 'Replaced cooling pump and cleaned filters',
            parts: 'Cooling Pump PN-4488, Filter x2',
            notes: 'Machine back to normal operation',
            photos: [],
            status: 'approved'
        });
    }
}

initDemo();
</script>

</body>
</html>
